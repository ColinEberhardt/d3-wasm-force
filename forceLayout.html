<!DOCTYPE html>
<meta charset="utf-8">
<canvas width="960" height="700"></canvas>
<script src="d3.js"></script>
<script>
   // TODO: does this need to be here?
   window.sqrt = Math.sqrt;
   window.min = Math.min;
</script>
<script src="build/bundle.js"></script>
<script>
  var canvas = document.querySelector("canvas"),
      context = canvas.getContext("2d"),
      width = canvas.width,
      height = canvas.height;

  d3wasm.load("build/force.wasm")
    .then(() => {

      d3.json("graph.json", function(error, graph) {
        if (error) throw error;

        const wasmGraph = JSON.parse(JSON.stringify(graph));

        // const simulation = d3.forceSimulation(graph.nodes)
        //   .force('charge', d3.forceManyBody())
        //   .force('center', d3.forceCenter())
        //   .force('link', d3.forceLink().links(graph.links).id(d => d.id))
        //   .stop();

        const simulationWasm = d3wasm.forceSimulation(wasmGraph.nodes, false)
          .force('charge', d3wasm.forceManyBody())
          .force('center', d3wasm.forceCenter())
          .force('link', d3wasm.forceLink().links(wasmGraph.links).id(d => d.id))
          .stop();
       
        function ticked() {
          context.clearRect(0, 0, width, height);

          // simulation.tick();
          // drawGraph(graph, '#f00');

          simulationWasm.tick();
          drawGraph(wasmGraph, '#0f0');
        }

        function drawGraph(g, fill) {
          context.save();
          context.translate(width / 2, height / 2 + 40);
      
          context.beginPath();
          g.links.forEach(drawLink);
          context.strokeStyle = "#aaa";
          context.stroke();
      
          context.beginPath();
          g.nodes.forEach(drawNode);
          context.fill();
          context.strokeStyle = fill;
          context.stroke();
      
          context.restore();
        }
      
        function drawLink(d) {
          context.moveTo(d.source.x, d.source.y);
          context.lineTo(d.target.x, d.target.y);
        }
      
        function drawNode(d) {
          context.moveTo(d.x + 3, d.y);
          context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
        }
      
        setInterval(ticked, 50);
        //ticked();
      });
  });
</script>
